<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>正在载入...</title>
    <style>
        /* 使用国内镜像加速艺术字体加载 */
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');

        :root { --paper: #f4ecd8; --ink: #1a1a1a; --vermilion: #b22222; --gold: #b89b5e; }
        
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: "Kaiti", "STKaiti", "楷体", serif; }

        #viewport { position: relative; width: 100%; height: 100%; overflow: hidden; }

        /* 背景堆叠 - 开启 GPU 加速 */
        #bg-container { position: absolute; width: 100%; height: 100%; z-index: 1; }
        .bg-layer {
            position: absolute; width: 115%; height: 115%; top: -7.5%; left: -7.5%;
            background-size: cover; background-position: center;
            opacity: 0; visibility: hidden; pointer-events: none;
            will-change: transform; /* 告诉浏览器提前准备 GPU */
        }
        .bg-layer.active { opacity: 1; visibility: visible; z-index: 2; }

        /* 黑场遮罩 */
        #black-overlay {
            position: absolute; inset: 0; background: #000;
            opacity: 0; z-index: 5; pointer-events: none;
            transition: opacity 0.45s ease-in-out;
        }
        #black-overlay.fading { opacity: 1; }

        /* 动画预设 */
        .zoom-move { animation: zoomMove 30s infinite alternate ease-in-out; }
        .pan-move { animation: panMove 30s infinite alternate ease-in-out; }
        @keyframes zoomMove { from { transform: scale(1) translateZ(0); } to { transform: scale(1.15) translateZ(0); } }
        @keyframes panMove { from { transform: scale(1.05) translateX(-2%) translateZ(0); } to { transform: scale(1.05) translateX(2%) translateZ(0); } }

        /* UI 容器 */
        #ui-container { position: absolute; bottom: 0; width: 100%; height: 35%; background: linear-gradient(transparent, rgba(0,0,0,0.85)); display: flex; justify-content: center; align-items: center; z-index: 10; pointer-events: none; }
        #dialogue-box { width: 85%; max-width: 900px; background: var(--paper); background-image: url('https://www.transparenttextures.com/patterns/handmade-paper.png'); border: 3px double var(--gold); padding: 30px; position: relative; pointer-events: auto; cursor: pointer; box-shadow: 0 10px 50px rgba(0,0,0,0.8); }
        #name-tag { position: absolute; top: -20px; left: 40px; background: var(--vermilion); color: white; padding: 5px 25px; font-weight: bold; font-size: 1.2rem; }
        #text-content { font-size: 1.5rem; line-height: 1.8; color: var(--ink); min-height: 100px; }
        
        .fade-in-text { animation: textReveal 0.6s forwards; }
        @keyframes textReveal { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* 右上角控制台 */
        .controls { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 20; align-items: flex-end; }
        .btn-side { writing-mode: vertical-rl; padding: 12px 6px; background: var(--paper); border: 1px solid var(--gold); cursor: pointer; letter-spacing: 2px; font-size: 0.9rem; box-shadow: 3px 3px 0 var(--gold); transition: 0.2s; }
        .btn-side:active { transform: translate(2px, 2px); box-shadow: none; }
        
        .volume-panel { background: var(--paper); border: 1px solid var(--gold); padding: 12px; display: flex; flex-direction: column; gap: 8px; box-shadow: 3px 3px 0 var(--gold); }
        .volume-row { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: var(--ink); }
        .volume-row input { cursor: pointer; accent-color: var(--vermilion); width: 80px; }

        /* 遮罩层样式 */
        .overlay { position: fixed; inset: 0; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #1a1a1a; transition: opacity 1s; }
        .title-card { background: var(--paper); padding: 50px 80px; border: 8px double var(--gold); text-align: center; }
        .btn-main { margin-top: 30px; padding: 12px 50px; background: var(--vermilion); color: white; border: none; font-size: 1.4rem; cursor: pointer; transition: 0.3s; }
        .btn-main:hover { background: #8e1b1b; }
        .btn-main:disabled { background: #666; cursor: wait; }
        
        #end-mark { font-family: 'Ma Shan Zheng', cursive; font-size: 10rem; color: white; opacity: 0; }
        .ink-reveal { animation: inkSpread 2.5s forwards; }
        @keyframes inkSpread { from { opacity: 0; filter: blur(20px); transform: scale(0.9); } to { opacity: 1; filter: blur(0); transform: scale(1); } }

        .hidden { display: none !important; }

        /* 自动计时条 */
        #auto-timer-bar { position: absolute; bottom: 0; left: 0; height: 3px; background: var(--vermilion); width: 0%; pointer-events: none; }
    </style>
</head>
<body>

    <audio id="bgm" loop preload="auto"></audio>

    <div id="cover" class="overlay">
        <div class="title-card">
            <h1 id="cover-title" style="font-size: 3.2rem; margin: 0; letter-spacing: 12px;">载入画卷中</h1>
            <p id="cover-subtitle" style="font-size: 1.1rem; color: #555; margin-top: 10px;"></p>
            <button id="start-btn" class="btn-main" onclick="startExperience()" disabled>加载中 0%</button>
        </div>
    </div>

    <div id="viewport">
        <div id="bg-container"></div>
        <div id="black-overlay"></div>
        
        <div class="controls">
            <button class="btn-side" onclick="prevStep()">回溯往昔</button>
            <div class="volume-panel">
                <div class="volume-row"><span>背景音</span><input type="range" id="bgm-vol" min="0" max="1" step="0.1" value="0.3" oninput="updateVolume()"></div>
                <div class="volume-row"><span>配音</span><input type="range" id="voice-vol" min="0" max="1" step="0.1" value="1" oninput="updateVolume()"></div>
                <button onclick="toggleMute()" id="mute-btn" style="width: 100%; cursor: pointer; background: #eee; border: 1px solid #ccc; font-size: 12px;">全静音</button>
            </div>
        </div>

        <div id="ui-container">
            <div id="dialogue-box" onclick="manualNext()">
                <div id="name-tag"></div>
                <div id="text-content"></div>
                <div id="auto-timer-bar"></div>
                <div style="text-align: right; font-size: 0.75rem; color: #999; margin-top: 15px; letter-spacing: 1px;">点击画面继续</div>
            </div>
        </div>
    </div>

    <div id="end-layer" class="overlay hidden">
        <div id="end-mark">完</div>
        <button class="btn-main" style="margin-top: 50px;" onclick="location.reload()">重新启阅</button>
    </div>

<script>
    /**
     * 故事数据配置
     */
    const storyBook = {
        config: { 
            title: "邹忌讽齐王纳谏",
            subtitle: "《战国策·齐策》",
            bgm: "https://cik07-cos.7moor-fs2.com/im/4d2c3f00-7d4c-11e5-af15-41bf63ae4ea0/079e1adb4aa9a3a4/hehuan.mp3" 
        },
        scenes: [
            { image: "https://s.coze.cn/t/fyP2We6gw5c/", name: "旁白", text: "邹忌修八尺有余，而形貌昳丽。朝服衣冠，窥镜，谓其妻曰——", voice: "", motion: "zoom-move" },
            { image: "https://s.coze.cn/t/fyP2We6gw5c/", name: "邹忌", text: "“我孰与城北徐公美？”", voice: "", motion: "pan-move" },
            { image: "https://s.coze.cn/t/3CKFv9v7xPM/", name: "其妻", text: "“君美甚，徐公何能及君也？”", voice: "", motion: "zoom-move" },
            { image: "https://s.coze.cn/t/aVdg2h96QvQ/", name: "邹忌", text: "忌不自信，而复问其妾曰：“吾孰与徐公美？”", voice: "", motion: "pan-move" },
            { image: "https://s.coze.cn/t/aVdg2h96QvQ/", name: "其妾", text: "“徐公何能及君也！”", voice: "", motion: "zoom-move" },
            { image: "https://s.coze.cn/t/bi4dnxBevtg/", name: "邹忌", text: "旦日，客从外来，与坐谈，问之客曰：“吾与徐公孰美？”", voice: "", motion: "pan-move" },
            { image: "https://s.coze.cn/t/u0dQEhyDni8/", name: "客", text: "“徐公不若君之美也。”", voice: "", motion: "zoom-move" },
            { image: "https://s.coze.cn/t/EroQ46z7MxA/", name: "旁白", text: "明日，徐公来，孰视之，自以为不如；窥镜而自视，又弗如远甚。暮寝而思之——", voice: "", motion: "zoom-move" },
            { image: "https://s.coze.cn/t/EroQ46z7MxA/", name: "邹忌", text: "“吾妻之美我者，私我也；妾之美我者，畏我也；客之美我者，欲有求于我也。”", voice: "", motion: "pan-move" },
            { image: "https://s.coze.cn/t/ULKUDwtOfs0/", name: "旁白", text: "于是入朝见威王曰——", voice: "", motion: "zoom-move" },
            { image: "https://s.coze.cn/t/ULKUDwtOfs0/", name: "邹忌", text: "“臣诚知不如徐公美。臣之妻私臣，臣之妾畏臣，臣之客欲有求于臣，皆以美于徐公。今齐地方千里，百二十城，宫妇左右莫不私王，朝廷之臣莫不畏王，四境之内莫不有求于王：由此观之，王之蔽甚矣。”", voice: "", motion: "pan-move" },
            { image: "https://s.coze.cn/t/hwS8S5hzNx4/", name: "齐王", text: "“善。”", voice: "", motion: "zoom-move" },
            { image: "https://s.coze.cn/t/1DjZgKrNilI/", name: "齐王", text: "“群臣吏民，能面刺寡人之过者，受上赏；上书谏寡人者，受中赏；能谤讥于市朝，闻寡人之耳者，受下赏。”", voice: "", motion: "zoom-move" },
            { image: "https://s.coze.cn/t/4uISn_w3Xmg/", name: "旁白", text: "令初下，群臣进谏，门庭若市；", voice: "", motion: "zoom-move" },
            { image: "https://s.coze.cn/t/saQgc_YC2nU/", name: "旁白", text: "数月之后，时时而间进；", voice: "", motion: "zoom-move" },
            { image: "https://s.coze.cn/t/B3Jb49B1ccQ/", name: "旁白", text: "期年之后，虽欲言，无可进者。", voice: "", motion: "zoom-move" },
            { image: "https://s.coze.cn/t/HSvb91rEXac/", name: "旁白", text: "燕、赵、韩、魏闻之，皆朝于齐。此所谓战胜于朝廷。", voice: "", motion: "zoom-move" }
        ]
    };

    let currentIndex = 0;
    let isTransitioning = false;
    let currentImgURL = ""; 
    let autoNextTimer = null;
    const voicePlayer = new Audio();
    const bgmPlayer = document.getElementById('bgm');

    // 初始化画卷
    function initBook() {
        document.title = storyBook.config.title;
        document.getElementById('cover-title').innerText = storyBook.config.title;
        document.getElementById('cover-subtitle').innerText = storyBook.config.subtitle;
        bgmPlayer.src = storyBook.config.bgm;
        
        const container = document.getElementById('bg-container');
        storyBook.scenes.forEach((scene, index) => {
            const layer = document.createElement('div');
            layer.id = `layer-${index}`;
            layer.className = `bg-layer ${scene.motion}`;
            layer.style.backgroundImage = `url('${scene.image}')`;
            container.appendChild(layer);
        });
        preloadResources();
    }

    // 预加载资源并显示进度
    function preloadResources() {
        const images = [...new Set(storyBook.scenes.map(s => s.image))];
        let loaded = 0;
        images.forEach(src => {
            const img = new Image();
            img.src = src;
            img.onload = img.onerror = () => {
                loaded++;
                const percent = Math.floor((loaded / images.length) * 100);
                const btn = document.getElementById('start-btn');
                btn.innerText = `加载画卷 ${percent}%`;
                if (loaded === images.length) {
                    btn.disabled = false;
                    btn.innerText = "开启画卷";
                }
            };
        });
    }

    // 用户交互触发播放（兼容移动端策略）
    function startExperience() {
        document.getElementById('cover').classList.add('hidden');
        updateVolume();
        bgmPlayer.play().catch(e => console.log("等待交互播放音频"));
        render(true); 
    }

    function updateVolume() {
        bgmPlayer.volume = document.getElementById('bgm-vol').value;
        voicePlayer.volume = document.getElementById('voice-vol').value;
    }

    function render(immediate = false) {
        clearTimeout(autoNextTimer);
        const bar = document.getElementById('auto-timer-bar');
        bar.style.transition = 'none';
        bar.style.width = '0%';

        if (currentIndex >= storyBook.scenes.length) {
            voicePlayer.pause();
            document.getElementById('end-layer').classList.remove('hidden');
            document.getElementById('end-mark').classList.add('ink-reveal');
            return;
        }

        const data = storyBook.scenes[currentIndex];
        
        // 核心连贯性判断：只有图片变了才闪黑场切层
        if (!immediate && data.image === currentImgURL) {
            updateContent(data);
        } else {
            if (immediate) {
                performLayerSwitch(data);
            } else {
                isTransitioning = true;
                const overlay = document.getElementById('black-overlay');
                overlay.classList.add('fading');
                setTimeout(() => {
                    performLayerSwitch(data);
                    overlay.classList.remove('fading');
                    setTimeout(() => { isTransitioning = false; }, 450);
                }, 500);
            }
        }
    }

    function performLayerSwitch(data) {
        document.querySelectorAll('.bg-layer').forEach(l => l.classList.remove('active'));
        const activeLayer = document.getElementById(`layer-${currentIndex}`);
        if(activeLayer) activeLayer.classList.add('active');
        currentImgURL = data.image;
        updateContent(data);
    }

    function updateContent(data) {
        // 更新配音
        voicePlayer.pause(); 
        if (data.voice && data.voice !== "") {
            voicePlayer.src = data.voice;
            voicePlayer.play().catch(() => {});
        } else {
            // 无配音：启动 5s 自动跳转
            const bar = document.getElementById('auto-timer-bar');
            setTimeout(() => {
                bar.style.transition = 'width 5s linear';
                bar.style.width = '100%';
            }, 50);
            autoNextTimer = setTimeout(() => { manualNext(); }, 5000);
        }

        // 更新文本
        document.getElementById('name-tag').innerText = data.name;
        const textEl = document.getElementById('text-content');
        textEl.innerText = data.text;
        textEl.classList.remove('fade-in-text');
        void textEl.offsetWidth; // 触发重绘
        textEl.classList.add('fade-in-text');
    }

    function manualNext() {
        if (isTransitioning) return;
        currentIndex++;
        render();
    }

    function prevStep() {
        if (isTransitioning || currentIndex <= 0) return;
        currentIndex--;
        render(); 
    }

    function toggleMute() {
        const isMuted = bgmPlayer.muted;
        bgmPlayer.muted = !isMuted;
        voicePlayer.muted = !isMuted;
        document.getElementById('mute-btn').innerText = isMuted ? "全静音" : "取消静音";
    }

    window.onload = initBook;
</script>
</body>
</html>